name: PM2 Auto Deploy

on:
  push:
    branches: [ master ] # 监听 master 分支的推送

jobs:
  deploy:
    # 关键：这里必须写 self-hosted，对应你刚才配置 Runner 时的标签
    runs-on: self-hosted

    steps:
      - name: Setup SSH known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY_LENOVO_SHOP_SERVER }}

      - name: Install and Restart API
        run: |
          # 1. 同步 runner 已 checkout 的代码到宝塔实际运行目录
          # 避免再用 git fetch，因为宝塔目录的 .git remote 仍是 HTTPS，会触发 SSL_ERROR_SYSCALL
          rsync -av --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            $GITHUB_WORKSPACE/ /www/wwwroot/api.jxutcm.top/
          
          # 2. 进入项目在宝塔的实际运行目录
          cd /www/wwwroot/api.jxutcm.top
          
          # 3. 极速安装依赖（使用国内源）
          pnpm install --registry=https://registry.npmmirror.com
          
          # 4. 重新生成 Prisma（如果有数据库变动）
          pnpm prisma generate
          
          # 5. 使用 PM2 平滑重启
          # --update-env 会重新读取最新的 .env 文件
          pm2 restart lenovo-shop-server --update-env || pm2 start "npx tsx src/index.ts" --name lenovo-shop-server